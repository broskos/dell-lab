#!/usr/bin/env bash
## this can be run from the satellite server, but you need jq
# run this on director or local machine with jq installed then scp to root@satellite

UPSTREAM_URL="registry.access.redhat.com"
curl -s https://${UPSTREAM_URL}/v1/search?q=rhosp13%20or%20rhceph-3 |jq '.results[] | .name' > satellite_image_names
sed -i 's/"//g' satellite_image_names

# execute these from the satellite server after configuring hammer for passwordless operation:
# https://access.redhat.com/solutions/1612123

# now scp the satellite_image_names filr over to the satellite server and run this from the satellite server:


MY_ORG="lab"
MY_PRODUCT="osp13_containers"
MY_LE="dev"
UPSTREAM_URL="registry.access.redhat.com"
SATELLITE_SERVER="satellite.lab.roskosb.info"
TEMPLATE_PATH="~/dell-lab/templates"

hammer product create \
--organization "${MY_ORG}" \
--name "${MY_PRODUCT}"

hammer repository create \
--organization "${MY_ORG}" \
--product "${MY_PRODUCT}" \
--content-type docker \
--url https://${UPSTREAM_URL} \
--docker-upstream-name rhosp13/openstack-base \
--name base

while read IMAGE; do \
  IMAGENAME=$(echo $IMAGE | cut -d"/" -f2 | sed "s/openstack-//g" | sed "s/:.*//g") ; \
  hammer repository create \
  --organization "${MY_ORG}" \
  --product "${MY_PRODUCT}" \
  --content-type docker \
  --url https://${UPSTREAM_URL} \
  --docker-upstream-name $IMAGE \
  --name $IMAGENAME ; done < satellite_image_names

hammer product synchronize \
--organization "${MY_ORG}" \
--name "${MY_PRODUCT}"

# let the containers sync down, then create the OSP13 CV, and the create the DEV Lifecycle env and promote
# the CV to the DEV LE
# Next move on and do the step below from director to get a current copy of the overcloud-images.yaml file with the correct
# image version tags.

# ---------------------------------------

# run this from director
# use all lower case for these, regardless if they are LC in satellite
MY_ORG="lab"
MY_LE="dev"
MY_CV="osp13"
MY_PRODUCT="osp13_containers"
SATELLITE_SERVER="satellite.lab.roskosb.info"
TEMPLATE_PATH="/home/stack/dell-lab/templates"

openstack overcloud container image prepare   \
--namespace="${SATELLITE_SERVER}:5000"   \
--prefix="${MY_ORG}-${MY_LE}-${MY_CV}-${MY_PRODUCT}-"   \
--tag-from-label {version}-{release} \
--output-env-file /home/stack/overcloud-images.yaml \
--set ceph_namespace="${SATELLITE_SERVER}:5000" \
--set ceph_image="${MY_ORG}-${MY_LE}-${MY_CV}-${MY_PRODUCT}-rhceph-3-rhel7"   \
    -r "${TEMPLATE_PATH}/roles_data.yaml" \
    -e /usr/share/openstack-tripleo-heat-templates/environments/network-isolation.yaml \
    -e /usr/share/openstack-tripleo-heat-templates/environments/network-environment.yaml \
    -e /usr/share/openstack-tripleo-heat-templates/environments/disable-telemetry.yaml \
    -e /usr/share/openstack-tripleo-heat-templates/environments/neutron-sriov.yaml \
    -e /usr/share/openstack-tripleo-heat-templates/environments/host-config-and-reboot.yaml \
    -e /usr/share/openstack-tripleo-heat-templates/environments/ceph-ansible/ceph-ansible.yaml \
    -e "${TEMPLATE_PATH}/environments/storage-config.yaml" \
    -e "${TEMPLATE_PATH}/environments/overcloud-images.yaml" \
    -e "${TEMPLATE_PATH}/environments/dell-lab-environment.yaml"
